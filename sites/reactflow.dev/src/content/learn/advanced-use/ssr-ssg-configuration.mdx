---

title: 服务端渲染
description: 分步指南：在服务器上渲染 React Flow 应用，用于展示静态流程图、从流程动态生成图像或在非 JavaScript 环境中渲染图表
---

# 服务端渲染与服务端生成

import { Callout } from 'nextra/components';

<Callout type="info">自 React Flow 12 起支持服务端渲染</Callout>

这是高级使用场景，假设您已熟悉 React Flow。若初次接触，请查阅我们的[入门指南](/learn/getting-started/installation-and-requirements)。

本指南将教您如何配置 React Flow 在服务端渲染流程图，使您能够：

- 在文档中展示静态 HTML 图表
- 在非 JS 环境中渲染 React Flow 图表
- 动态生成 Open Graph 图像，当分享流程图链接时显示为嵌入内容

（如需下载流程图图像，客户端有更简便的方法，参见我们的[下载图像示例](/examples/misc/download-image)。）

### 节点尺寸

要使 React Flow 在服务端正常工作，您需要配置几个关键事项，其中最重要的是节点尺寸。React Flow 仅在节点具有宽度和高度时才会渲染它们。通常您传递的节点不包含特定 `width` 和 `height` 属性，此时系统会测量尺寸并将结果写入 `measured.width` 和 `measured.height`。由于无法在服务端测量尺寸，我们需要显式传递这些值。这可以通过节点的 `width` 和 `height` 或 `initialWidth` 和 `initialHeight` 属性实现。

```js
const nodes = [
  {
    id: '1',
    type: 'default',
    position: { x: 0, y: 0 },
    data: { label: 'Node 1' },
    width: 100,
    height: 50,
  },
];
```

现在 React Flow 已获知节点尺寸，可以在服务端进行渲染。`width` 和 `height` 属性会作为节点的内联样式使用。如果您预期客户端节点的尺寸会变化，或尺寸需要根据内容动态调整，可以使用 `initialWidth` 和 `initialHeight` 属性。这些属性仅用于首次渲染（服务端或客户端），在节点未被测量且 `measured.width` 和 `measured.height` 未设置时生效。

<Callout type="default">
  <strong>
    服务端渲染时指定节点尺寸的两种方式：
  </strong>
  <div>
    1. `width` 和 `height`：用于预先已知且不会改变的静态尺寸
  </div>
  <div>
    2. `initialWidth` 和 `initialHeight`：用于无法预先确定或需要动态变化的尺寸
  </div>
</Callout>

### 处理定位

您可能还希望在服务器端渲染边线。在客户端，React Flow 会检查手柄位置并存储这些信息来绘制边线。由于我们无法在服务器端测量手柄位置，因此也需要传递这些信息。这可以通过节点的 `handles` 属性实现。

```js
const nodes: Node[] = [
  {
    id: '1',
    type: 'default',
    position: { x: 0, y: 0 },
    data: { label: 'Node 1' },
    width: 100,
    height: 50,
    handles: [
      {
        type: 'target',
        position: Position.Top,
        x: 100 / 2,
        y: 0,
      },
      {
        type: 'source',
        position: Position.Bottom,
        x: 100 / 2,
        y: 50,
      },
    ],
  },
];
```

通过这些额外信息，React Flow 就能获取足够的手柄数据来在服务器端渲染边线。如果仅需渲染节点，可以跳过此步骤。

### 在服务器端使用 `fitView`

如果您知道 React Flow 容器本身的尺寸，甚至可以在服务器端使用 `fitView`。为此，您需要将容器的 `width` 和 `height` 传递给 `ReactFlow` 组件。

```js
<ReactFlow nodes={nodes} edges={edges} fitView width={1000} height={500} />
```

这将计算视口并在服务器端设置 `transform`，以确保所有节点都包含在视口中。

### 与 `<ReactFlowProvider>` 配合使用

如果使用 `ReactFlowProvider`，可以向该提供者传递 `initialNodes`、`initialEdges` 以及可选的容器尺寸（`initialWidth` 和 `initialHeight`）和 `fitView` 参数。

```js
<ReactFlowProvider
  initialNodes={nodes}
  initialEdges={edges}
  initialWidth={1000}
  initialHeight={500}
  fitView
>
  <App />
</ReactFlowProvider>
```

`initial-` 前缀表示这些值仅用于首次渲染。之后，提供者将使用上下文中的 `nodes` 和 `edges`。

### 创建静态 HTML

如需生成静态 HTML，可以使用 React 提供的 `renderToStaticMarkup` 函数。该函数会将 React Flow 组件渲染为 HTML 字符串，随后可将此字符串用于创建静态 HTML 文件或作为 HTTP 请求的响应内容。

```js
import React from 'react';
import { renderToStaticMarkup } from 'react-dom/server';
import { ReactFlow, Background } from '@xyflow/react';

function toHTML({ nodes, edges, width, height }) {
  const html = renderToStaticMarkup(
    React.createElement(
      ReactFlow,
      {
        nodes,
        edges,
        width,
        height,
        minZoom: 0.2,
        fitView: true,
      },
      React.createElement(Background, null),
    ),
  );

  return html;
}
```