---

sidebarTitle: State Management
description: 学习如何将 React Flow 与 Zustand、Redux、Recoil 或 Jotai 等状态管理库结合使用。
---

# 使用状态管理库

import { Callout } from 'nextra/components';
import { RemoteCodeViewer } from 'xy-shared/server';

<Callout type="info">
  本指南假设您已了解 React Flow 的[核心概念](/learn/concepts/core-concepts)及如何实现[自定义节点](/learn/customization/custom-nodes)。同时您应熟悉状态管理库的基本概念及其使用方法。
</Callout>

本指南将演示如何结合使用 React Flow 与状态管理库 [Zustand](https://github.com/pmndrs/zustand)。我们将构建一个包含颜色选择器的小型应用，每个节点可通过该选择器更新背景色。选择 Zustand 是因为 React Flow 内部已使用该库，但您同样可以轻松集成其他状态管理方案，例如 [Redux](https://redux.js.org/)、[Recoil](https://recoiljs.org/) 或 [Jotai](https://jotai.org/)。

如之前的指南和示例所示，React Flow 可以轻松配合本地组件状态来管理图表中的节点和边。但随着应用规模增长，当需要从单个节点内部更新状态时，状态管理会变得复杂。与其通过节点的 data 字段传递函数，您可以使用 [React context](https://reactjs.org/docs/context.html) 或集成 Zustand 这样的状态管理库，正如本指南所述。

## 安装 Zustand

如前所述，本示例将使用 Zustand。Zustand 类似于 Redux：您拥有一个中心存储库，其中包含用于修改状态的操作和访问状态的钩子。可通过以下命令安装：

```bash copy npm2yarn
npm install --save zustand
```

## 创建存储库

Zustand 允许您创建钩子来访问存储库中的值和函数。我们将 `nodes`、`edges` 以及 `onNodesChange`、`onEdgesChange`、`onConnect`、`setNodes` 和 `setEdges` 函数放入存储库，为图表提供基础交互功能：

<RemoteCodeViewer route="learn/state-management" framework="react" />

至此已完成基础配置。现在我们拥有一个包含节点和边的存储库，能够处理由 React Flow 触发的变更（拖动、选择或删除节点/边）。查看 `App.tsx` 文件时，您会发现代码保持简洁清晰。所有数据和操作现在都归属于存储库，可通过 `useStore` 钩子访问。

## 实现颜色变更操作

我们新增了一个 `updateNodeColor` 操作来更新特定节点的 `data.color` 字段。为此，我们将节点 ID 和新颜色传递给该操作，遍历所有节点并使用新颜色更新匹配的节点：

```ts
updateNodeColor: (nodeId: string, color: string) => {
  set({
    nodes: get().nodes.map((node) => {
      if (node.id === nodeId) {
        // it's important to create a new object here, to inform React Flow about the changes
        return { ...node, data: { ...node.data, color } };
      }

      return node;
    }),
  });
};
```

现在可以在 React 组件中这样使用该新操作：

```tsx
const updateNodeColor = useStore((s) => s.updateNodeColor);
...
<button onClick={() => updateNodeColor(nodeId, color)} />;
```

## 添加颜色选择器节点

在这一步中，我们实现 `ColorChooserNode` 组件，并在用户更改颜色时调用 `updateNodeColor`。颜色选择器节点的自定义部分是颜色输入框。

```jsx
<input
  type="color"
  defaultValue={data.color}
  onChange={(evt) => updateNodeColor(id, evt.target.value)}
  className="nodrag"
/>
```

我们添加了 `nodrag` 类名，以防止用户在更改颜色时误拖动节点，并在 `onChange` 事件处理程序中调用 `updateNodeColor`。

<RemoteCodeViewer
  route="learn/state-management-2"
  framework="react"
  activeFile="ColorChooserNode.tsx"
/>

现在您可以点击颜色选择器来更改节点的背景色。