---

description: 了解如何扩展 React Flow 来计算流经流程图的数据。
---

# 计算数据流

import { Callout } from 'nextra/components';
import { RemoteCodeViewer } from 'xy-shared/server';

<Callout type="info">
  本指南假设您已了解 React Flow 的[核心概念](/learn/concepts/core-concepts)及如何实现[自定义节点](/learn/customization/custom-nodes)。
</Callout>

通常开发者会通过将数据发送到服务器或数据库等方式，在 React Flow 外部处理数据。本指南将展示如何在 React Flow 内部直接计算数据流。您可以用这种方式基于连接数据更新节点，或构建完全运行在浏览器内的应用。

## 我们将构建什么？

通过本指南，您将构建一个交互式流程图：通过三个独立的数字输入字段（红、绿、蓝）生成颜色，并判断在该背景色上显示白色还是黑色文本更易读。

<RemoteCodeViewer route="learn/computing-6" framework="react" />

## 创建自定义节点

首先创建自定义输入节点 (`NumberInput.js`) 并添加三个实例。我们将使用受控的 `<input type="number" />` 组件，并在 `onChange` 事件处理程序中限制输入值为 0-255 之间的整数。

```jsx
import { useCallback, useState } from 'react';
import { Handle, Position } from '@xyflow/react';

function NumberInput({ id, data }) {
  const [number, setNumber] = useState(0);

  const onChange = useCallback((evt) => {
    const cappedNumber = Math.round(
      Math.min(255, Math.max(0, evt.target.value)),
    );
    setNumber(cappedNumber);
  }, []);

  return (
    <div className="number-input">
      <div>{data.label}</div>
      <input
        id={`number-${id}`}
        name="number"
        type="number"
        min="0"
        max="255"
        onChange={onChange}
        className="nodrag"
        value={number}
      />
      <Handle type="source" position={Position.Right} />
    </div>
  );
}

export default NumberInput;
```

接下来，我们将添加一个新的自定义节点（`ColorPreview.js`），为每个颜色通道配备一个目标连接点，并显示最终合成颜色的背景。我们可以使用 `mix-blend-mode: 'difference';` 确保文字颜色始终清晰可读。

<Callout type="info">
  当单个节点上存在多个同类型连接点时，请务必为每个连接点分配唯一标识符！
</Callout>

趁此机会，我们还可以将输入节点到颜色节点的连线添加到 `initialEdges` 数组中。

<RemoteCodeViewer
  route="learn/computing"
  framework="react"
  activeFile="ColorPreview.jsx"
/>

## 数据计算

如何将输入节点的数据传输到颜色节点？这个过程分为两步，需要用到专为此场景设计的两个钩子：

1. 通过 [`updateNodeData`](/api-reference/types/react-flow-instance#update-node-data) 回调函数，将每个数字输入值存储到节点的 `data` 对象中。
2. 使用 [`useNodeConnections`](/api-reference/hooks/use-node-connections) 查找相连节点，再通过 [`useNodesData`](/api-reference/hooks/use-nodes-data) 获取相连节点的数据。

### 第一步：将数值写入数据对象

首先，我们在 `initialNodes` 数组的 `data` 对象中为输入节点添加一些初始值，并将它们用作输入节点的初始状态。
然后，我们从 [`useReactFlow`](/api-reference/hooks/use-react-flow) 钩子中获取 [`updateNodeData`](/api-reference/types/react-flow-instance#update-node-data) 函数，每当输入发生变化时，使用该函数更新节点的 `data` 对象为新值。

<Callout type="info">
默认情况下，传递给 [`updateNodeData`](/api-reference/types/react-flow-instance#update-node-data) 的数据会与旧数据对象合并。这使得部分更新更加方便，并在您忘记添加 `{...data}` 时提供保护。您可以通过传递 `{ replace: true }` 作为选项来替换整个对象。
</Callout>

<RemoteCodeViewer
  route="learn/computing-2"
  framework="react"
  activeFile="NumberInput.jsx"
/>

<Callout type="warning">
  <b>
    处理输入字段时，不应直接将节点的 `data` 对象用作 UI 状态。
  </b>
  更新数据对象存在延迟，可能导致光标异常跳动并产生意外输入。
</Callout>

### 第二步：从连接的节点获取数据

我们首先使用 [`useNodeConnections`](/api-reference/hooks/use-node-connections) 钩子确定每个节点的所有连接，然后通过 [`updateNodeData`](/api-reference/types/react-flow-instance#update-node-data) 获取第一个连接节点的数据。

<Callout type="info">
  请注意，每个连接点(handle)可以连接多个节点，您可能需要在应用中限制单个连接点的连接数量。查看[连接限制示例](/examples/nodes/connection-limit)了解具体实现方法。
</Callout>

<b>大功告成！</b> 尝试修改输入值，实时观察颜色变化。

<RemoteCodeViewer
  route="learn/computing-3"
  framework="react"
  activeFile="ColorPreview.jsx"
/>

### 代码优化

先获取连接关系再单独获取每个连接点的数据可能显得不够优雅。对于这种具有多个连接点的节点，建议创建自定义连接点组件来隔离连接状态与节点数据绑定。我们可以内联创建一个。

```jsx filename="ColorPreview.js"
// {...}
function CustomHandle({ id, label, onChange }) {
  const connections = useNodeConnections({
    handleType: 'target',
    handleId: id,
  });

  const nodeData = useNodesData(connections?.[0].source);

  useEffect(() => {
    onChange(nodeData?.data ? nodeData.data.value : 0);
  }, [nodeData]);

  return (
    <div>
      <Handle
        type="target"
        position={Position.Left}
        id={id}
        className="handle"
      />
      <label htmlFor="red" className="label">
        {label}
      </label>
    </div>
  );
}
```

可以将颜色提升为局部状态，并按如下方式声明每个连接点：

```jsx filename="ColorPreview.js"
// {...}
function ColorPreview() {
  const [color, setColor] = useState({ r: 0, g: 0, b: 0 });

  return (
    <div
      className="node"
      style={{
        background: `rgb(${color.r}, ${color.g}, ${color.b})`,
      }}
    >
      <CustomHandle
        id="red"
        label="R"
        onChange={(value) => setColor((c) => ({ ...c, r: value }))}
      />
      <CustomHandle
        id="green"
        label="G"
        onChange={(value) => setColor((c) => ({ ...c, g: value }))}
      />
      <CustomHandle
        id="blue"
        label="B"
        onChange={(value) => setColor((c) => ({ ...c, b: value }))}
      />
    </div>
  );
}

export default ColorPreview;
```

## 实现更复杂功能

现在我们已经掌握了通过React Flow传递数据的基础方法。如果想实现更复杂的功能呢？比如在传输过程中转换数据，或者选择不同路径？这些同样可以实现！

### 扩展流程

让我们扩展流程：先在颜色节点添加输出端 `<Handle type="source" position={Position.Right} />`，然后移除本地组件状态。

<Callout type="info">
  由于该节点没有输入字段，我们完全不需要维护本地状态。直接读取和更新节点的`data`对象即可。
</Callout>

接下来，我们添加一个新节点（`Lightness.js`），它接收一个颜色对象并判断其属于浅色还是深色。我们可以使用[相对亮度公式](https://en.wikipedia.org/wiki/Relative_luminance#Relative_luminance_and_%22gamma_encoded%22_colorspaces)：
`luminance = 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b`
来计算颜色的感知亮度（0表示最暗，255表示最亮）。我们可以假设所有亮度值 >= 128 的颜色都属于浅色。

<RemoteCodeViewer
  route="learn/computing-4"
  framework="react"
  activeFile="Lightness.jsx"
/>

### 条件分支

如果我们希望根据感知亮度在流程中采取不同路径该怎么办？让我们为亮度节点添加两个源连接点 `light` 和 `dark`，并按源连接点ID分离节点的 `data` 对象。当存在多个源连接点时，这是区分各连接点数据所必需的。

但"采取不同路径"具体意味着什么？一个解决方案是假设连接到目标连接点的 `null` 或 `undefined` 数据被视为"停止"。在本例中，我们可以将传入的浅色写入 `data.values.light`，深色写入 `data.values.dark`，并将另一对应值设为 `null`。

别忘了添加 `flex-direction: column;` 和 `align-items: end;` 来重新定位连接点标签。

<RemoteCodeViewer
  route="learn/computing-5"
  framework="react"
  activeFile="Lightness.jsx"
/>

太棒了！现在我们只需要最后一个节点来验证实际效果...我们可以创建一个自定义调试节点(`Log.js`)来显示连接的数据，这样就大功告成了！

<RemoteCodeViewer
  route="learn/computing-6"
  framework="react"
  activeFile="Log.jsx"
/>

## 概述

你已经掌握了如何在流程中传递数据并沿途进行转换。
具体只需做到：

1. 借助 [`updateNodeData`](/api-reference/types/react-flow-instance#update-node-data) 回调将数据存储在节点的 `data` 对象中
2. 使用 [`useNodeConnections`](/api-reference/hooks/use-node-connections) 找出连接的节点，然后通过 [`useNodesData`](/api-reference/hooks/use-nodes-data) 获取来自连接节点的数据

例如可以通过将未定义的输入数据视为"停止"信号来实现分支逻辑。值得一提的是，大多数包含分支的流程图通常会将节点触发机制与实际节点数据分离处理，Unreal Engine 的蓝图系统就是典型范例。

<Callout type="info">
  最后提醒：你应该建立统一的数据结构规范，而不是像我们刚才演示的那样混用多种方案。这意味着如果你开始采用按句柄ID拆分数据的做法，就应该在所有节点中保持一致，无论它们是否拥有多个句柄。能够在整个流程中对数据结构做出明确假设，将大幅降低开发复杂度。
</Callout>