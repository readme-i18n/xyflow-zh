---

description: 本指南将展示如何为你的流程添加基础交互功能。
---

import { Callout, Steps } from 'nextra/components';
import { RemoteCodeViewer } from 'xy-shared/server';

# 添加交互功能

我们已经完成了[第一个流程](learn/concepts/building-a-flow)的构建，现在让我们添加交互功能，使你可以选择、拖拽和删除节点与连线。

## 处理变更事件

默认情况下，除了处理视口外，React Flow 不会管理任何内部状态更新。就像处理 HTML `<input />` 元素一样，你需要向 React Flow 传递[事件处理器](/api-reference/react-flow#event-handlers)才能将触发的变更应用到你的节点和连线上。

<Steps>
 ### 导入依赖

为了管理变更，我们将使用 React Flow 提供的 `useState` 和两个辅助函数：
[`applyNodeChanges`](/api-reference/utils/apply-node-changes) 与
[`applyEdgeChanges`](/api-reference/utils/apply-edge-changes)。首先导入这些函数：

```jsx
import { useState, useCallback } from 'react';
import { ReactFlow, applyEdgeChanges, applyNodeChanges } from '@xyflow/react';
```

### 定义节点与边

需要定义初始的节点和边数据，这些将作为流程图的起点：

```jsx
const initialNodes = [
  {
    id: 'n1',
    position: { x: 0, y: 0 },
    data: { label: 'Node 1' },
    type: 'input',
  },
  {
    id: 'n2',
    position: { x: 100, y: 100 },
    data: { label: 'Node 2' },
  },
];

const initialEdges = [
  {
    id: 'n1-n2',
    source: 'n1',
    target: 'n2',
  },
];
```

### 初始化状态

在组件中调用 `useState` 钩子来管理节点和边的状态：

```jsx {2-3}
export default function App() {
  const [nodes, setNodes] = useState(initialNodes);
  const [edges, setEdges] = useState(initialEdges);

  return (
    <div style={{ height: '100%', width: '100%' }}>
      <ReactFlow>
        <Background />
        <Controls />
      </ReactFlow>
    </div>
  );
}
```

### 添加事件处理器

需要创建两个事件处理器：
[`onNodesChange`](/api-reference/react-flow#onnodeschange) 和
[`onEdgesChange`](/api-reference/react-flow#onedgeschange)。它们会在元素发生拖拽或删除等变更时更新状态：

```jsx
const onNodesChange = useCallback(
  (changes) => setNodes((nodesSnapshot) => applyNodeChanges(changes, nodesSnapshot)),
  [],
);
const onEdgesChange = useCallback(
  (changes) => setEdges((edgesSnapshot) => applyEdgeChanges(changes, edgesSnapshot)),
  [],
);
```

### 传递给 ReactFlow

将节点、边数据和事件处理器传递给 `<ReactFlow />` 组件：

```jsx {2-5}
<ReactFlow
  nodes={nodes}
  edges={edges}
  onNodesChange={onNodesChange}
  onEdgesChange={onEdgesChange}
  fitView
>
  <Background />
  <Controls />
</ReactFlow>
```

### 交互式流程图

大功告成！现在你已拥有一个基础交互式流程图 🎉

当拖拽或选择节点时，`onNodesChange` 处理器会被触发。`applyNodeChanges` 函数利用这些变更事件更新节点状态。以下是完整效果，尝试点击并拖拽节点移动，观察界面实时更新：

<RemoteCodeViewer
  route="learn/make-it-interactive-1"
  framework="react"
  aspectRatio="4"
/>

</Steps>

## 连接处理

最后缺失的部分是：实现节点间的交互式连接。为此，我们需要实现一个 [`onConnect`](/api-reference/react-flow#onconnect) 处理函数。

<Steps>
### 创建 `onConnect` 处理函数

当两个节点之间建立新连接时，系统会调用 `onConnect` 处理函数。我们可以使用 [`addEdge`](/api-reference/utils/add-edge) 工具函数来创建新边并更新边数组。

```jsx
const onConnect = useCallback(
  (params) => setEdges((edgesSnapshot) => addEdge(params, edgesSnapshot)),
  [],
);
```

### 传递给 ReactFlow

现在我们可以将 `onConnect` 处理函数传递给 `<ReactFlow />` 组件：

```jsx {6}
<ReactFlow
  nodes={nodes}
  edges={edges}
  onNodesChange={onNodesChange}
  onEdgesChange={onEdgesChange}
  onConnect={onConnect}
  fitView
>
  <Background />
  <Controls />
</ReactFlow>
```

### 可连接流程图

尝试通过从一个连接柄拖动到另一个来连接两个节点。此时会触发 `onConnect` 处理函数，新边将被添加到流程图中。🥳

<RemoteCodeViewer
  aspectRatio="4"
  route="learn/make-it-interactive-2"
  framework="react"
/>

</Steps>

## 完整代码示例 🏁

<RemoteCodeViewer route="learn/make-it-interactive-2" framework="react" />

这里发生了什么？每当 React Flow 触发变更（节点初始化、节点拖拽、边选择等）时，系统会调用 `onNodesChange` 处理函数。我们导出了 `applyNodeChanges` 处理函数，这样您就无需自行处理变更。`applyNodeChanges` 处理函数会返回更新后的节点数组作为您的新节点数组。现在您已拥有具备以下功能的交互式流程图：

- 可选择的节点和边
- 可拖拽的节点
- 通过从一个节点手柄拖拽到另一个实现节点连接
- 按住 `shift` 键启用多选区域（默认的 [`selectionKeyCode`](/api-reference/react-flow#selectionkeycode)）
- 按住 `cmd` 键进行多选（默认的 [`multiSelectionKeyCode`](/api-reference/react-flow#multiselectionkeycode)）
- 按 `backspace` 键删除选中元素（默认的 [`deleteKeyCode`](/api-reference/react-flow#deletekeycode)）

若想直接开始创建自己的应用，建议查阅[自定义](/learn/customization)章节。否则请继续阅读以了解更多 React Flow 的功能特性。