---

sidebarTitle: 迁移至 v12
description: 使用本指南从 React Flow 11 迁移至 12 版本。
created_at: 2024-07-15
---

# 迁移至 React Flow 12

import { Callout } from 'nextra/components';

<Callout type="info">
  旧版 React Flow 文档可在此查阅：
  [v11](https://v11.reactflow.dev), [v10](https://v10.reactflow.dev),
  [v9](https://v9.reactflow.dev)
</Callout>

在您能使用 React Flow 12 的**[新特性](#new-features)**（如服务端渲染、流程计算和暗黑模式）之前，需要先处理以下破坏性变更。我们已尽量减少破坏性变更，但部分变更是实现新功能所必需的。

## 迁移指南

开始迁移前，需先安装新包。

```bash npm2yarn
npm install @xyflow/react
```

### 1. 新的 npm 包名称

包名 `reactflow` 已更名为 `@xyflow/react` 且不再支持默认导入。同时需要调整样式导入方式。v12 之前 React Flow 被拆分为多个包，现在不再如此。若您仅使用核心功能，现在需安装 `@xyflow/react` 包。

**旧版 API**

```js
// npm install reactflow
import ReactFlow from 'reactflow';
```

**新版 API**

```js
// npm install @xyflow/react
import { ReactFlow } from '@xyflow/react';

// you also need to adjust the style import
import '@xyflow/react/dist/style.css';

// or if you just want basic styles
import '@xyflow/react/dist/base.css';
```

### 2. 节点的 <code>measured</code> 属性用于测量 <code>width</code> 和 <code>height</code>

所有测量后的节点值现在存储在 `node.measured` 中。除了新的包名称外，这是最大的变更。当 React Flow 测量完您的节点后，会将尺寸写入 `node.measured.width` 和 `node.measured.height`。如果您使用 dagre 或 elk 等布局库，现在需要从 `node.measured` 而非 `node` 获取尺寸。若您使用 `width` 和 `height`，这些值现在将作为内联样式来指定节点尺寸。

**旧版 API**

```js
// getting the measured width and height
const nodeWidth = node.width;
const nodeHeight = node.height;
```

**新版 API**

```js
// getting the measured width and height
const nodeWidth = node.measured?.width;
const nodeHeight = node.measured?.height;
```

### 3. 新的尺寸处理方式 <code>node.width</code> / <code>node.height</code> 与 <code>node.measured.width</code> / <code>node.measured.height</code> 对比

为支持服务端渲染，我们重构了部分 API 以便更轻松地传递节点尺寸。为此我们改变了 `node.width` 和 `node.height` 属性的行为。在 React Flow 11 中，这些属性是测量值且仅作为参考。而在 React Flow 12 中，这些属性被用作内联样式来指定节点尺寸。若您从数据库加载节点，可能需要移除节点中的 `width` 和 `height` 属性，因为其行为已略有不同。现在使用 `width` 和 `height` 意味着尺寸不再基于内容动态变化，而是固定值。

**旧版 API**

```js
// in React Flow 11 you might have used node.style to set the dimensions
const nodes = [
  {
    id: '1',
    type: 'input',
    data: { label: 'input node' },
    position: { x: 250, y: 5 },
    style: { width: 180, height: 40 },
  },
];
```

**新版 API**

```js
// in React Flow 12 you can used node.width and node.height to set the dimensions
const nodes = [
  {
    id: '1',
    type: 'input',
    data: { label: 'input node' },
    position: { x: 250, y: 5 },
    width: 180,
    height: 40,
  },
];
```

如需了解更多关于如何配置 React Flow 进行服务端渲染的信息，请参阅[服务端渲染指南](/learn/advanced-use/ssr-ssg-configuration)。

### 4. 更新节点与边

我们不再支持通过对象突变来更新节点和边。如需更新特定属性，必须创建新的节点/边。

**旧版 API**

```js
setNodes((currentNodes) =>
  currentNodes.map((node) => {
    node.hidden = true;
    return node;
  }),
);
```

**新版 API**

```js
setNodes((currentNodes) =>
  currentNodes.map((node) => ({
    ...node,
    hidden: true,
  })),
);
```

### 5. 将 <code>onEdgeUpdate</code>（及相关 API）重命名为 <code>onReconnect</code>

我们将 `onEdgeUpdate` 函数及其相关 API（如下所列）重命名为 `onReconnect`。新名称更具描述性，能更清晰地表明该函数用于重新连接边。

- `updateEdge` 更名为 `reconnectEdge`
- `onEdgeUpdateStart` 更名为 `onReconnectStart`
- `onEdgeUpdate` 更名为 `onReconnect`
- `onEdgeUpdateEnd` 更名为 `onReconnectEnd`
- `edgeUpdaterRadius` 更名为 `reconnectRadius`
- `edge.updatable` 更名为 `edge.reconnectable`
- `edgesUpdatable` 更名为 `edgesReconnectable`

**旧版 API**

```js
<ReactFlow
  onEdgeUpdate={onEdgeUpdate}
  onEdgeUpdateStart={onEdgeUpdateStart}
  onEdgeUpdateEnd={onEdgeUpdateEnd}
/>
```

**新版 API**

```js
<ReactFlow
  onReconnect={onReconnect}
  onReconnectStart={onReconnectStart}
  onReconnectEnd={onReconnectEnd}
/>
```

### 6. 将 <code>parentNode</code> 重命名为 <code>parentId</code>

使用子流程时，需将 `node.parentNode` 更名为 `node.parentId`。原 `parentNode` 属性容易引起误解，因为它并非指向父节点的引用，而是父节点的 `id`。

**旧版 API**

```js
const nodes = [
  // some nodes ...
  {
    id: 'xyz-id',
    position: { x: 0, y: 0 },
    type: 'default',
    data: {},
    parentNode: 'abc-id',
  },
];
```

**新版 API**

```js
const nodes = [
  // some nodes ...
  {
    id: 'xyz-id',
    position: { x: 0, y: 0 },
    type: 'default',
    data: {},
    parentId: 'abc-id',
  },
];
```

### 7. 自定义节点属性

我们将 `xPos` 和 `yPos` 属性更名为 `positionAbsoluteX` 和 `positionAbsoluteY`

**旧版 API**

```js
function CustomNode({ xPos, yPos }) {
  ...
}
```

**新版 API**

```js
function CustomNode({ positionAbsoluteX, positionAbsoluteY }) {
  ...
}
```

### 8. 处理组件类名

我们重命名了用于定义连接点状态的类名：

- `react-flow__handle-connecting` 更名为 `connectingto` / `connectingfrom`
- `react-flow__handle-valid` 更名为 `valid`

### 9. <code>getNodesBounds</code> 参数选项

第二个参数的类型从 `nodeOrigin` 改为 `options.nodeOrigin`

**旧版 API**

```js
const bounds = getNodesBounds(nodes: Node[], nodeOrigin)
```

**新版 API**

```js
const bounds = getNodesBounds(nodes: Node[], { nodeOrigin })
```

### 10. 节点与边的 TypeScript 类型变更

我们简化了类型定义并修复了涉及 NodeData 泛型的函数问题。新方案要求通过联合类型自定义节点类型，现在可以支持多种不同数据结构的节点类型，并通过检查 `node.type` 属性进行区分。

**新版 API**

```js
type NumberNode = Node<{ value: number }, 'number'>;
type TextNode = Node<{ text: string }, 'text'>;
type AppNode = NumberNode | TextNode;
```

随后可按以下方式使用 `AppNode` 类型：

```js
const nodes: AppNode[] = [
  { id: '1', type: 'number', data: { value: 1 }, position: { x: 100, y: 100 } },
  { id: '2', type: 'text', data: { text: 'Hello' }, position: { x: 200, y: 200 } },
];
```

```js
const onNodesChange: onNodesChange<AppNode> = useCallback((changes) => setNodes(nds => applyChanges(changes, nds)), []);
```

更多细节请参阅 [TypeScript 指南](/learn/advanced-use/typescript)。

### 11. 重命名 <code>nodeInternals</code>

若使用 `nodeInternals`，需将其更名为 `nodeLookup`。

**旧版 API**

```js
const node = useStore((s) => s.nodeInternals.get(id));
```

**新版 API**

```js
const node = useStore((s) => s.nodeLookup.get(id));
```

### 12. 移除已弃用函数

我们移除了以下已弃用函数：

- `getTransformForBounds`（已由 `getViewportForBounds` 替代）
- `getRectOfNodes`（已由 `getNodesBounds` 替代）
- `project`（已由 `screenToFlowPosition` 替代）
- `getMarkerEndId`
- `updateEdge`（已由 `reconnectEdge` 替代）

### 13. 自定义 <code>applyNodeChanges</code> 和 <code>applyEdgeChanges</code>

如果您编写了自己的变更应用函数，现在需要处理新增的 "replace" 事件。我们移除了 "reset" 事件，并添加了用于替换特定节点或边的 "replace" 事件。

## 新功能

成功迁移至 v12 后，您可以使用所有炫酷的新特性。如上所述，v12 最重要的更新包括：

### 1. 服务端渲染

现在您可以为节点定义 `width`、`height` 和 `handles` 属性。这使得服务端渲染流程并在客户端注水成为可能：[服务端渲染指南](/learn/advanced-use/ssr-ssg-configuration)。

- **详细信息：** 在 v11 版本中，`width` 和 `height` 会在节点完成测量后由库自动设置。这一机制仍然保留，但我们现在改用 `measured.width` 和 `measured.height` 来存储这些信息。旧版本中关于 `width` 和 `height` 的用法经常引发混淆——用户难以理解这两个属性不能用于传递实际宽高值，也不易察觉它们是由库自动添加的。我们认为新实现方案同时解决了这两个问题：`width` 和 `height` 现在是可选的维度定义属性，而所有由库计算的尺寸都会存储在 `measured` 中。

### 2. 计算流

新增的钩子 [`useHandleConnections`](/api-reference/hooks/use-handle-connections) 和 [`useNodesData`](/api-reference/hooks/use-nodes-data)，以及 [`updateNode`](/api-reference/hooks/use-react-flow#update-node) 和 [`updateNodeData`](/api-reference/hooks/use-react-flow#update-node-data) 函数（两者均属于 `useReactFlow`）可用于管理节点间的数据流：[计算流指南](/learn/advanced-use/computing-flows)。我们还为边（edge）添加了对应的辅助函数（`updateEdge` 和 `updateEdgeData`）！

- **详情说明:** 在处理节点数据相互依赖的流程时（例如节点A更新后需要联动更新相连的节点B），这种场景极为常见。此前开发者必须自行实现定制方案。本次版本我们提供了高性能工具函数来优雅处理此类用例。

### 3. 暗黑模式与 CSS 变量

React Flow 现已内置暗黑模式，通过新的 [`colorMode`](/api-reference/react-flow#color-mode) 属性（可选 "light"、"dark" 或 "system"）即可切换：[暗黑模式示例](/examples/styling/dark-mode)

- **详情说明:** 本版本简化了明暗模式切换流程，并为暗色系流程提供了更完善的基础支持。当设置 `colorMode="dark"` 时，框架会自动为容器添加 "dark" 类名并应用对应样式。为实现这一特性，我们已将大部分样式迁移至 CSS 变量体系，这些变量也可用于用户自定义流程样式。

### 4. 通过 TSDoc 提升开发体验

我们开始采用 TSDoc 来优化开发体验。现在开发时 IDE 会直接显示属性和钩子的文档说明，这是提升库易用性的重要一步。未来我们还将基于 TSDoc 自动生成文档。

### 更多功能与更新

不仅如此！除了主要的新功能外，我们还实现了一些长期待办清单中的小改进：

- **[`useConnection` 钩子](/api-reference/hooks/use-connection)**：通过该钩子可以访问当前连接。例如，可用于根据起始/终止手柄状态自定义连接线样式或着色手柄。
- **受控 `viewport`**：此为高级功能，典型用例包括视口动画或为低分辨率屏幕适配变换坐标。新增两个属性：[`viewport`](/api-reference/react-flow#viewport) 和 [`onViewportChange`](/api-reference/react-flow#on-viewport-change)。
- **[`ViewportPortal` 组件](/api-reference/components/viewport-portal)**：无需实现自定义节点即可在视口中渲染元素。
- **[`onDelete` 处理器](/api-reference/react-flow#on-delete)**：新增合并处理器，统一处理节点和边的删除事件。
- **[`onBeforeDelete` 处理器](/api-reference/react-flow#on-before-delete)**：通过该处理器可阻止或管理删除操作。
- **[`isValidConnection` 属性](/api-reference/react-flow#is-valid-connection)**：为所有连接实现统一验证逻辑，包括编程方式添加的边。
- **[`autoPanSpeed` 属性](/api-reference/react-flow#autoPanSpeed)**：控制自动平移时的速度。
- **[`paneClickDistance` 属性](/api-reference/react-flow#paneClickDistance)**：触发点击事件的鼠标按下/释放最大距离阈值。
- **Background 组件**：新增 [`patternClassName`](/api-reference/components/background#pattern-class-name) 属性，支持通过类名自定义背景图案样式（例如配合 Tailwind 使用）。
- **`onMove` 回调**：在库触发的视口更新时触发（如 fitView 或缩放操作）。
- **`deleteElements`** 现在返回被删除的节点和边
- 为节点添加 **`origin` 属性**
- 为边添加 **`selectable` 属性**
- **节点缩放器更新**：调整组大小时子节点不再移动，正确识别边界和扩展范围
- 修正 `BezierEdge`、`StepEdge`、`SmoothStepEdge` 和 `StraightEdge` 组件的类型定义
- 库创建的新边仅在设置时才会包含 `sourceHandle` 和 `targetHandle` 属性（原逻辑会传递 `sourceHandle: null` 和 `targetHandle: null`）
- 边在 z-index 变化时不再重新挂载/卸载
- 连接线可感知目标手柄位置以确保路径绘制正确
- `nodeDragThreshold` 默认值由 0 改为 1
- 优化选择框使用体验（拖拽出画布时仍保持捕获）
- 在 `NodeProps` 中添加 `selectable`、`deletable`、`draggable` 和 `parentId` 属性
- 添加样式未加载时的警告提示

### 内部变更

这些变更不会直接影响用户界面，但对于使用 React Flow 内部存储机制的开发者可能较为重要：

- 最主要的内部变更是我们创建了新包 **@xyflow/system，包含与框架无关的辅助工具**，可供 React Flow 和 Svelte Flow 共同使用
  - **XYDrag** 用于处理节点拖拽和选区操作
  - **XYPanZoom** 用于控制视口的平移和缩放
  - **XYHandle** 用于管理新连接
- 我们将 `nodeInternals` 重命名为 `nodeLookup`。该映射表仅作为查找表使用，由于变更时不会创建新映射对象，因此命名更贴合实际用途
- 移除了内部的 "reset" 事件，新增 "replace" 事件以实现特定节点的更新
- 从存储中移除了 `connectionNodeId`、`connectionHandleId`、`connectionHandleType`，改为使用 `connection.fromHandle.nodeId`、`connection.fromHandle.id` 等新属性
- 为边(edges)添加 `data-id` 属性
- 当用户拖拽选区时，除了触发 `onSelectionDragStart`、`onSelectionDrag`、`onSelectionDragStop` 外，现在也会调用 `onNodeDragStart`、`onNodeDrag` 和 `onNodeDragStop`